apiVersion: apps/v1
kind: Deployment
metadata:
  name: spanner-truetime
spec:
  replicas: 1
  selector:
    matchLabels:
      app: spanner-truetime
  template:
    metadata:
      labels:
        app: spanner-truetime
    spec:
      containers:
      - name: spanner-truetime
        image: gcr.io/cloud-spanner-emulator/emulator:latest
        ports:
        - containerPort: 9010
          name: grpc
        - containerPort: 9020
          name: http
---
apiVersion: v1
kind: Service
metadata:
  name: spanner
spec:
  ports:
  - port: 9010
    name: grpc
  - port: 9020
    name: http
  selector:
    app: spanner-truetime
---
apiVersion: batch/v1
kind: Job
metadata:
  name: spanner-truetime-init
spec:
  template:
    spec:
      containers:
      - name: spanner-truetime-init
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Waiting for Spanner emulator to start..."
          until curl -s http://spanner:9020/ > /dev/null; do
            echo "Waiting for Spanner emulator..."
            sleep 2
          done
          echo "Creating instance..."
          curl -s -X POST http://spanner:9020/v1/projects/test-project/instances \
            -H "Content-Type: application/json" \
            -d '{"instanceId": "test-instance", "instance": {"config": "emulator-config", "displayName": "Test Instance", "nodeCount": 1}}'
          echo "\nCreating database..."
          curl -s -X POST http://spanner:9020/v1/projects/test-project/instances/test-instance/databases \
            -H "Content-Type: application/json" \
            -d '{"createStatement": "CREATE DATABASE `test-db`", "extraStatements": ["CREATE TABLE events (id STRING(36) DEFAULT (GENERATE_UUID()), description STRING(MAX)) PRIMARY KEY(id)"]}'
          echo "\nInitialization complete."
      restartPolicy: OnFailure
