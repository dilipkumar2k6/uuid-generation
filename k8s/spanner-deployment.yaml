apiVersion: apps/v1
kind: Deployment
metadata:
  name: spanner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: spanner
  template:
    metadata:
      labels:
        app: spanner
    spec:
      containers:
      - name: spanner
        image: gcr.io/cloud-spanner-emulator/emulator:latest
        ports:
        - containerPort: 9010
          name: grpc
        - containerPort: 9020
          name: http
---
apiVersion: v1
kind: Service
metadata:
  name: spanner
spec:
  ports:
  - port: 9010
    name: grpc
  - port: 9020
    name: http
  selector:
    app: spanner
---
apiVersion: batch/v1
kind: Job
metadata:
  name: spanner-init
spec:
  template:
    spec:
      containers:
      - name: spanner-init
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Waiting for Spanner emulator to start..."
          sleep 5
          echo "Creating instance..."
          curl -s -X POST http://spanner:9020/v1/projects/test-project/instances \
            -H "Content-Type: application/json" \
            -d '{"instanceId": "test-instance", "instance": {"config": "emulator-config", "displayName": "Test Instance", "nodeCount": 1}}'
          echo "\nCreating database and sequence..."
          curl -s -X POST http://spanner:9020/v1/projects/test-project/instances/test-instance/databases \
            -H "Content-Type: application/json" \
            -d '{"createStatement": "CREATE DATABASE `test-db`", "extraStatements": ["CREATE SEQUENCE uuid_sequence OPTIONS (sequence_kind=\"bit_reversed_positive\")"]}'
          echo "\nInitialization complete."
      restartPolicy: OnFailure
