apiVersion: v1
kind: ConfigMap
metadata:
  name: proxysql-config
data:
  proxysql.cnf: |
    mysql_servers =
    (
      { address="mysql1" , port=3306 , hostgroup=1, max_connections=200 },
      { address="mysql2" , port=3306 , hostgroup=1, max_connections=200 }
    )

    mysql_users =
    (
      { username="root" , password="root" , default_hostgroup=1 }
    )

    mysql_variables =
    {
      have_ssl = "false"
    }
---
apiVersion: v1
kind: Service
metadata:
  name: proxysql
spec:
  ports:
  - port: 6033
    name: mysql
  - port: 6032
    name: admin
  selector:
    app: proxysql
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxysql
spec:
  selector:
    matchLabels:
      app: proxysql
  template:
    metadata:
      labels:
        app: proxysql
    spec:
      containers:
      - name: proxysql
        image: proxysql/proxysql:2.3.2
        args: ["--initial"]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/proxysql.cnf
          subPath: proxysql.cnf
        ports:
        - containerPort: 6033
        - containerPort: 6032
      volumes:
      - name: config-volume
        configMap:
          name: proxysql-config
