apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-dual-buffer-init
data:
  init.sql: |
    CREATE DATABASE IF NOT EXISTS uuid_db;
    USE uuid_db;
    CREATE TABLE IF NOT EXISTS id_segments (
        biz_tag VARCHAR(50) PRIMARY KEY,
        max_id BIGINT NOT NULL,
        step INT NOT NULL
    ) ENGINE=InnoDB;
    INSERT IGNORE INTO id_segments (biz_tag, max_id, step) VALUES ('default', 0, 1000);
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-dual-buffer
spec:
  ports:
  - port: 3306
  selector:
    app: mysql-dual-buffer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-dual-buffer
spec:
  selector:
    matchLabels:
      app: mysql-dual-buffer
  template:
    metadata:
      labels:
        app: mysql-dual-buffer
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: root
        - name: MYSQL_DATABASE
          value: uuid_db
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
      volumes:
      - name: init-script
        configMap:
          name: mysql-dual-buffer-init
